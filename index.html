<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DriveMate AI</title>
    
    <!-- PWA & Mobile Optimization -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DriveMate">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <!-- Google Fonts 導入によるスマートなタイポグラフィ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body { 
            background-color: #000;
            color: white; 
            overflow: hidden; 
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            height: 100vh;
            width: 100vw;
        }

        /* アプリコンテナ */
        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #0f172a;
            overflow: hidden;
        }

        /* PCプレビュー用枠線 */
        @media (min-width: 640px) {
            .app-container {
                width: 393px;
                height: 852px;
                max-height: 92vh;
                border-radius: 3.5rem;
                border: 10px solid #1e293b;
                box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7);
                margin: auto;
            }
        }

        #map { 
            height: 100%; 
            width: 100%; 
            filter: grayscale(0.5) invert(0.9) hue-rotate(180deg) brightness(0.7);
            z-index: 1;
        }

        /* 3Dグラスモーフィズム */
        .status-card { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85) 0%, rgba(15, 23, 42, 0.95) 100%); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.05);
        }

        .g-circle { 
            width: 80px; height: 80px; 
            border-radius: 50%; position: relative; 
            background: radial-gradient(circle at 50% 100%, #0f172a, #1e293b);
            box-shadow: inset 0 6px 15px rgba(0,0,0,0.8), 0 1px 2px rgba(255,255,255,0.05);
            border: 1px solid #334155;
        }

        .g-ball { 
            width: 14px; height: 14px; 
            border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: radial-gradient(circle at 30% 30%, #34d399, #059669); 
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.6), inset -2px -2px 4px rgba(0,0,0,0.4);
            transition: transform 0.1s cubic-bezier(0.1, 0.5, 0.1, 1);
        }

        /* アプリ通知風ポップアップ */
        #popup { 
            transform: translate(-50%, -150%); 
            opacity: 0; 
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
            z-index: 5000;
        }
        #popup.show { transform: translate(-50%, calc(20px + var(--safe-top))); opacity: 1; }

        .btn-3d {
            background: linear-gradient(to bottom, #2563eb, #1d4ed8);
            border-bottom: 5px solid #1e3a8a;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            transition: all 0.1s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }
        .btn-3d:active {
            transform: translateY(3px);
            border-bottom-width: 2px;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }
        .btn-3d:disabled {
            background: #1e293b;
            border-bottom-width: 2px;
            box-shadow: none;
            transform: translateY(3px);
            color: #64748b;
        }

        .bottom-sheet {
            padding-bottom: calc(1.5rem + var(--safe-bottom));
            padding-top: 1.5rem;
            box-shadow: 0 -25px 50px rgba(0,0,0,0.8);
            z-index: 10;
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <div class="app-container">
        
        <!-- ヘッダー -->
        <header class="absolute top-0 w-full z-[2000] bg-gradient-to-b from-slate-950/90 to-transparent flex items-center justify-between px-6 pt-[var(--safe-top)] h-[calc(70px+var(--safe-top))] pointer-events-none">
            <div class="flex items-center gap-3">
                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_10px_#10b981]"></div>
                <div class="flex flex-col">
                    <span class="font-black text-[13px] tracking-widest text-white/90">DriveMate<span class="text-emerald-400">.AI</span></span>
                    <span class="text-[8px] text-slate-400 font-bold tracking-[0.3em]">安全運転解析システム</span>
                </div>
            </div>
            <div id="gps-status" class="text-[9px] text-emerald-400 font-bold tracking-wider bg-emerald-950/40 px-3 py-1.5 rounded-full border border-emerald-500/30 backdrop-blur-sm">GPS捕捉済</div>
        </header>

        <!-- マップ表示エリア -->
        <div class="flex-1 w-full relative">
            <div id="map"></div>
        </div>

        <!-- アシスタント通知（ポップアップ） -->
        <div id="popup" class="absolute left-1/2 -translate-x-1/2 w-[92%] max-w-[400px]">
            <div class="status-card p-4 rounded-[2.5rem] flex items-center gap-4 border border-white/20">
                <div id="popup-icon" class="w-14 h-14 rounded-full bg-slate-800 flex items-center justify-center border border-white/10 flex-shrink-0 shadow-inner"></div>
                <div class="flex-1">
                    <div id="popup-category" class="text-[10px] font-black text-slate-400 tracking-widest mb-0.5">運転アドバイス</div>
                    <div id="popup-msg" class="text-[14px] font-bold text-white leading-snug tracking-tight"></div>
                </div>
            </div>
        </div>

        <!-- ボトムパネル（計器類とボタン） -->
        <div class="bottom-sheet bg-slate-900/98 backdrop-blur-3xl rounded-t-[3.5rem] -mt-12 relative px-6 space-y-6 border-t border-white/10">
            
            <div class="w-16 h-1.5 bg-slate-700/40 rounded-full mx-auto -mt-3 mb-4"></div>

            <div class="grid grid-cols-2 gap-4">
                <!-- 速度メーター -->
                <div class="status-card h-36 rounded-[2.5rem] flex flex-col items-center justify-center relative overflow-hidden">
                    <div class="flex flex-col items-center mb-1">
                        <span class="text-[12px] text-slate-300 font-bold tracking-widest">現在速度</span>
                        <span class="text-[8px] text-slate-500 font-black tracking-[0.2em] uppercase">Speed</span>
                    </div>
                    <div class="flex items-baseline gap-1 relative z-10">
                        <span id="speed-val" class="text-6xl font-black text-white tabular-nums tracking-tighter">0</span>
                        <span class="text-[11px] text-slate-400 font-bold">km/h</span>
                    </div>
                </div>

                <!-- Gメーター -->
                <div class="status-card h-36 rounded-[2.5rem] flex flex-col items-center justify-center relative">
                    <div class="flex flex-col items-center mb-2">
                        <span class="text-[12px] text-slate-300 font-bold tracking-widest">Gセンサー</span>
                        <span class="text-[8px] text-slate-500 font-black tracking-[0.2em] uppercase">G-Force</span>
                    </div>
                    <div class="g-circle">
                        <div id="g-ball" class="g-ball"></div>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-[8px] text-slate-500 font-bold opacity-80">
                            <span class="absolute top-0.5">加速</span>
                            <span class="absolute bottom-0.5">減速</span>
                            <span class="absolute left-1">左</span>
                            <span class="absolute right-1">右</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- アシスタントメッセージ -->
            <div class="flex items-center gap-4 bg-slate-800/40 p-4 rounded-[2rem] border border-slate-700 shadow-inner">
                <div class="relative flex-shrink-0">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.3)] border border-blue-400/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" />
                        </svg>
                    </div>
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 border-[3px] border-slate-900 rounded-full shadow-lg animate-pulse"></div>
                </div>
                <div class="flex-1">
                    <p id="instructor-hint" class="text-[13px] text-slate-200 font-medium leading-relaxed tracking-tight">
                        教習準備が整いました。<br>「計測を開始」をタップしてください。
                    </p>
                </div>
            </div>

            <!-- メインアクション（不要な補正ボタンを削除し、全幅の大きなボタンに変更） -->
            <div class="pt-1">
                <button id="start-btn" class="w-full btn-3d text-white font-bold py-4 rounded-[2rem] text-[15px] tracking-widest flex flex-col items-center justify-center transition-all">
                    <span>計測を開始</span>
                    <span class="text-[9px] font-black text-blue-200 uppercase tracking-[0.3em] mt-0.5 opacity-80">Start Session</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let map, marker, preferredVoice = null;
        let isDriving = false;
        let lastSpeakTime = 0;
        let speedLimit = 50; 

        const ADVICE = {
            SUDDEN_BRAKE: { msg: "ブレーキが少し強めでしたね。もう少し余裕を持って踏み始めましょう。", type: "warning" },
            SUDDEN_START: { msg: "急発進ですよ。アクセルは優しく、ゆっくり踏み込んでみてください。", type: "warning" },
            SUDDEN_TURN: { msg: "ハンドル操作が少し急です。もっと滑らかに回すよう意識しましょう。", type: "warning" },
            OVERSPEED: { msg: "スピードが出すぎていますね。法定速度を守って安全に走りましょう。", type: "danger" },
            START: { msg: "お待たせしました。それでは、安全に気をつけて出発しましょう。", type: "info" }
        };

        window.onload = () => {
            initMap();
            initVoice();
        };

        function initVoice() {
            const voices = window.speechSynthesis.getVoices();
            preferredVoice = voices.find(v => v.lang === 'ja-JP' && v.name.includes('Google')) 
                          || voices.find(v => v.lang === 'ja-JP' && (v.name.includes('Kyoko') || v.name.includes('Otoya')))
                          || voices.find(v => v.lang.includes('ja'));
        }
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoice;
        }

        function initMap() {
            try {
                map = L.map('map', { 
                    zoomControl: false, 
                    attributionControl: false
                }).setView([35.6812, 139.7671], 17);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="width:20px; height:20px; background:#3b82f6; border:3px solid white; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                marker = L.marker([35.6812, 139.7671], { icon: customIcon }).addTo(map);
            } catch (error) {
                console.error("Map initialization failed:", error);
            }
        }

        // iOSなどで音声を許可させるための初期化処理
        function unlockAudio() {
            const uttr = new SpeechSynthesisUtterance('');
            uttr.volume = 0;
            window.speechSynthesis.speak(uttr);
        }

        function speak(text) {
            const now = Date.now();
            if (now - lastSpeakTime < 5000) return; 
            
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.0; 
            uttr.pitch = 1.05; 
            if (preferredVoice) uttr.voice = preferredVoice;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(uttr);
            lastSpeakTime = now;
        }

        function showPopup(adviceObj) {
            const popup = document.getElementById('popup');
            const msgEl = document.getElementById('popup-msg');
            const catEl = document.getElementById('popup-category');
            const iconContainer = document.getElementById('popup-icon');

            let iconSvg = '', colorClass = '';
            if (adviceObj.type === 'danger') {
                iconSvg = `<svg class="w-7 h-7 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/></svg>`;
                colorClass = 'text-red-500';
            } else if (adviceObj.type === 'warning') {
                iconSvg = `<svg class="w-7 h-7 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/></svg>`;
                colorClass = 'text-amber-500';
            } else {
                iconSvg = `<svg class="w-7 h-7 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/></svg>`;
                colorClass = 'text-blue-500';
            }

            iconContainer.innerHTML = iconSvg;
            msgEl.innerText = adviceObj.msg;
            catEl.innerText = adviceObj.type === 'info' ? '運転アドバイス' : '安全警告';
            catEl.className = `text-[10px] font-black tracking-widest mb-1 ${colorClass}`;
            
            popup.classList.add('show');
            speak(adviceObj.msg);
            setTimeout(() => popup.classList.remove('show'), 4500);
        }

        document.getElementById('start-btn').addEventListener('click', async () => {
            try {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission !== 'granted') {
                        document.getElementById('instructor-hint').innerHTML = "センサーが許可されていません。<br>設定を確認してください。";
                        return;
                    }
                }
                
                if(!preferredVoice) initVoice();
                unlockAudio();
                
                isDriving = true;
                const btn = document.getElementById('start-btn');
                btn.innerHTML = `<span>計測中</span><span class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] mt-0.5">Active</span>`;
                btn.disabled = true;
                
                document.getElementById('instructor-hint').innerHTML = "走行解析を開始しました。<br><span class='text-emerald-400 font-bold'>安全運転でお願いいたします。</span>";
                
                showPopup(ADVICE.START);
                startTracking();
                startMotion();
            } catch (e) {
                console.error("Permission error:", e);
                document.getElementById('instructor-hint').innerText = "エラーが発生しました。設定を確認してください。";
            }
        });

        function startTracking() {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const speed = Math.round((pos.coords.speed || 0) * 3.6); 
                
                document.getElementById('speed-val').innerText = speed;
                if(map && marker) {
                    map.panTo([lat, lng]);
                    marker.setLatLng([lat, lng]);
                }
                
                document.getElementById('gps-status').innerText = "GPS捕捉済";
                document.getElementById('gps-status').className = "text-[9px] text-emerald-400 font-bold tracking-wider bg-emerald-950/40 px-3 py-1.5 rounded-full border border-emerald-500/30 backdrop-blur-sm";
                
                if (speed > speedLimit + 5) {
                    showPopup(ADVICE.OVERSPEED);
                }
            }, (err) => {
                console.warn("GPS error:", err);
                document.getElementById('gps-status').innerText = "GPSエラー";
                document.getElementById('gps-status').className = "text-[9px] text-red-400 font-bold tracking-wider bg-red-950/40 px-3 py-1.5 rounded-full border border-red-500/30 backdrop-blur-sm";
            }, { 
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 5000
            });
        }

        function startMotion() {
            window.addEventListener('devicemotion', (event) => {
                if (!isDriving) return;
                
                let acc = event.acceleration; 
                if (!acc || acc.x === null) {
                    acc = event.accelerationIncludingGravity;
                }
                if (!acc || acc.x === null) return;
                
                const gX = Number(acc.x) / 9.8 || 0;
                const gY = Number(acc.y) / 9.8 || 0; 
                
                const ball = document.getElementById('g-ball');
                
                const moveX = Math.max(-32, Math.min(32, gX * 70));
                const moveY = Math.max(-32, Math.min(32, gY * 70));
                
                ball.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY * -1}px))`;
                
                if (gY < -0.38) {
                    showPopup(ADVICE.SUDDEN_BRAKE);
                } else if (gY > 0.38) {
                    showPopup(ADVICE.SUDDEN_START);
                } else if (Math.abs(gX) > 0.38) {
                    showPopup(ADVICE.SUDDEN_TURN);
                }
            });
        }
    </script>
</body>
</html>
